
> speed-date@0.1.0 test:backend:unit
> vitest run backend/tests/unit


[1m[46m RUN [49m[22m [36mv4.0.13 [39m[90m/Users/bb/Desktop/speed[39m

[90mstdout[2m | backend/tests/unit/state-machine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (6) from .env.local -- tip: ğŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | backend/tests/unit/queue.test.ts
[22m[39m[dotenv@17.2.3] injecting env (6) from .env.local -- tip: ğŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | backend/tests/unit/voting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (6) from .env.local -- tip: ğŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | backend/tests/unit/state-machine.test.ts[2m > [22m[2mState Machine Unit Tests[2m > [22m[2mshould transition vote_active â†’ ended on yes/yes
[22m[39mError voting user1: {
  code: [32m'P0001'[39m,
  details: [1mnull[22m,
  hint: [1mnull[22m,
  message: [32m'Match not found or not in vote_active state'[39m
}
Error voting user2: {
  code: [32m'P0001'[39m,
  details: [1mnull[22m,
  hint: [1mnull[22m,
  message: [32m'Match not found or not in vote_active state'[39m
}

 [31mâ¯[39m backend/tests/unit/state-machine.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 41756[2mms[22m[39m
     [33m[2mâœ“[22m[39m should transition spin_active â†’ queue_waiting [33m 5410[2mms[22m[39m
     [33m[2mâœ“[22m[39m should transition queue_waiting â†’ paired [33m 4934[2mms[22m[39m
     [33m[2mâœ“[22m[39m should transition paired â†’ vote_active [33m 4988[2mms[22m[39m
[31m     [31mÃ—[31m should transition vote_active â†’ ended on yes/yes[39m[33m 11213[2mms[22m[39m
     [33m[2mâœ“[22m[39m should transition vote_active â†’ spin_active on respin [33m 4694[2mms[22m[39m
     [33m[2mâœ“[22m[39m should reject illegal transitions [33m 4929[2mms[22m[39m
     [33m[2mâœ“[22m[39m should reject transition from wrong current state [33m 5577[2mms[22m[39m
[90mstdout[2m | backend/tests/unit/matching.test.ts
[22m[39m[dotenv@17.2.3] injecting env (6) from .env.local -- tip: ğŸ”‘ add access controls to secrets: https://dotenvx.com/ops

 [31mâ¯[39m backend/tests/unit/voting.test.ts [2m([22m[2m7 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 65096[2mms[22m[39m
     [33m[2mâœ“[22m[39m should create match on yes/yes [33m 9522[2mms[22m[39m
[31m     [31mÃ—[31m should respin yes voter on yes/pass[39m[33m 9278[2mms[22m[39m
     [33m[2mâœ“[22m[39m should respin yes voter on yes/idle [33m 9012[2mms[22m[39m
     [33m[2mâœ“[22m[39m should not respin on idle/idle [33m 9025[2mms[22m[39m
     [33m[2mâœ“[22m[39m should not respin on pass/pass [33m 9088[2mms[22m[39m
     [33m[2mâœ“[22m[39m should terminate match when pass before partner votes [33m 10049[2mms[22m[39m
     [33m[2mâœ“[22m[39m should detect countdown expiration [33m 9111[2mms[22m[39m
[90mstdout[2m | backend/tests/unit/disconnection.test.ts
[22m[39m[dotenv@17.2.3] injecting env (6) from .env.local -- tip: ğŸ“¡ add observability to secrets: https://dotenvx.com/ops

 [32mâœ“[39m backend/tests/unit/queue.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 97539[2mms[22m[39m
     [33m[2mâœ“[22m[39m should join queue correctly [33m 5274[2mms[22m[39m
     [33m[2mâœ“[22m[39m should leave queue correctly [33m 4996[2mms[22m[39m
     [33m[2mâœ“[22m[39m should prevent duplicate queue entries [33m 4977[2mms[22m[39m
     [33m[2mâœ“[22m[39m should increment fairness score over time [33m 5065[2mms[22m[39m
     [33m[2mâœ“[22m[39m should increment waiting time [33m 6160[2mms[22m[39m
     [33m[2mâœ“[22m[39m should trigger preference expansion at 10 seconds [33m 15875[2mms[22m[39m
     [33m[2mâœ“[22m[39m should trigger preference expansion at 15 seconds [33m 20265[2mms[22m[39m
     [33m[2mâœ“[22m[39m should trigger preference expansion at 20 seconds [33m 24990[2mms[22m[39m
     [33m[2mâœ“[22m[39m should apply +10 priority boost correctly [33m 5028[2mms[22m[39m
     [33m[2mâœ“[22m[39m should reject offline user instantly [33m 4904[2mms[22m[39m
 [32mâœ“[39m backend/tests/unit/disconnection.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 35826[2mms[22m[39m
     [33m[2mâœ“[22m[39m should remove from queue on disconnect before match [33m 5058[2mms[22m[39m
     [33m[2mâœ“[22m[39m should apply cooldown on disconnect during pairing [33m 4962[2mms[22m[39m
     [33m[2mâœ“[22m[39m should apply cooldown on disconnect during vote [33m 4810[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow reconnect within 10 seconds [33m 4916[2mms[22m[39m
     [33m[2mâœ“[22m[39m should treat reconnect after 10 seconds as new user [33m 16075[2mms[22m[39m
 [32mâœ“[39m backend/tests/unit/matching.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 69247[2mms[22m[39m
     [33m[2mâœ“[22m[39m should enforce gender strictness [33m 9986[2mms[22m[39m
     [33m[2mâœ“[22m[39m should enforce age boundaries in strict mode [33m 8900[2mms[22m[39m
     [33m[2mâœ“[22m[39m should expand age boundaries at stage 1 [33m 9117[2mms[22m[39m
     [33m[2mâœ“[22m[39m should enforce never-pair-again blacklist [33m 9008[2mms[22m[39m
     [33m[2mâœ“[22m[39m should enforce cooldown rule [33m 8924[2mms[22m[39m
     [33m[2mâœ“[22m[39m should prevent atomic pairing from creating three-way matches [33m 14218[2mms[22m[39m
     [33m[2mâœ“[22m[39m should handle SKIP LOCKED under conflicts [33m 9090[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 2 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m backend/tests/unit/state-machine.test.ts[2m > [22mState Machine Unit Tests[2m > [22mshould transition vote_active â†’ ended on yes/yes
[31m[1mAssertionError[22m: expected 'pending' to be 'matched' // Object.is equality[39m

Expected: [32m"matched"[39m
Received: [31m"pending"[39m

[36m [2mâ¯[22m backend/tests/unit/state-machine.test.ts:[2m156:27[22m[39m
    [90m154| [39m
    [90m155| [39m    [90m// submit_vote sets status to 'matched', not 'ended'[39m
    [90m156| [39m    [34mexpect[39m(match[33m?.[39mstatus)[33m.[39m[34mtoBe[39m([32m'matched'[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m157| [39m  }[33m,[39m [34m15000[39m)[33m;[39m [90m// Increase timeout[39m
    [90m158| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/2]â¯[22m[39m

[41m[1m FAIL [22m[49m backend/tests/unit/voting.test.ts[2m > [22mVoting Unit Tests[2m > [22mshould respin yes voter on yes/pass
[31m[1mTypeError[22m: actual value must be number or bigint, received "undefined"[39m
[36m [2mâ¯[22m backend/tests/unit/voting.test.ts:[2m132:40[22m[39m
    [90m130| [39m      [33m.[39m[34msingle[39m()[33m;[39m
    [90m131| [39m
    [90m132| [39m    [34mexpect[39m(queueEntry[33m?.[39mfairness_score)[33m.[39m[34mtoBeGreaterThanOrEqual[39m([34m10[39m)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m133| [39m  })[33m;[39m
    [90m134| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/2]â¯[22m[39m


[2m Test Files [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (5)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m34 passed[39m[22m[90m (36)[39m
[2m   Start at [22m 23:22:34
[2m   Duration [22m 114.37s[2m (transform 819ms, setup 0ms, collect 3.13s, tests 309.46s, environment 2ms, prepare 75ms)[22m

