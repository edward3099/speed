  
  -- Remove from queue
  DELETE FROM queue WHERE user_id = p_user_id;
  
  -- Apply cooldown
  PERFORM set_cooldown(p_user_id);
  
  -- Log disconnect
  INSERT INTO debug_logs (user_id, event_type, metadata, severity)
  VALUES (p_user_id, 'user_disconnected', jsonb_build_object('had_match', FOUND), 'warning');
END;
$$;

COMMENT ON FUNCTION handle_disconnect IS 'Handles user disconnect: breaks match, applies cooldown, gives partner boost if yes voter';


-- ============================================================================
-- 113_fix_compatibility.sql
-- ============================================================================

-- ============================================================================
-- Migration 113: Fix Compatibility Issues
-- ============================================================================
-- Fixes for compatibility with existing schema
-- ============================================================================

-- Fix find_best_match to work with user_preferences instead of profiles for age/distance
-- Age and distance are in user_preferences, not profiles
-- Profiles might have age, but distance is calculated or in preferences

-- Update find_best_match function to use user_preferences for compatibility scoring
-- This will be handled in the function itself

-- Ensure user_preferences table has required columns
DO $$
BEGIN
  -- Add preference_stage tracking if needed (might already exist)
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'user_preferences') THEN
    -- Check if columns exist, add if missing
    -- Most columns should already exist
    NULL; -- Placeholder - actual columns depend on existing schema
  END IF;
END $$;

-- Create helper function to get user age (from profiles)
CREATE OR REPLACE FUNCTION get_user_age(p_user_id UUID)
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  user_age INTEGER;
BEGIN
  -- Get age from profiles table
  SELECT age INTO user_age
  FROM profiles
  WHERE id = p_user_id;
  
  -- Return age or NULL if not found
  RETURN user_age;
END;
$$;

-- Create helper function to get user distance (calculated or from preferences)
CREATE OR REPLACE FUNCTION get_user_distance(p_user_id UUID, p_partner_id UUID)
RETURNS DECIMAL
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  user_distance DECIMAL;
  user_location TEXT;
  partner_location TEXT;
BEGIN
  -- Try to get distance from profiles if available
  -- Check if profiles has distance_km column or calculate from location
  -- For now, return a default - implement based on your location system
  -- You may need to calculate haversine distance from lat/lng or use stored distance
  
  -- Placeholder: return default distance
  -- TODO: Implement actual distance calculation based on your schema
  RETURN 50; -- Default distance (miles or km - adjust based on your system)
END;
$$;

COMMENT ON FUNCTION get_user_age IS 'Helper to get user age from profiles';
COMMENT ON FUNCTION get_user_distance IS 'Helper to get distance between users (placeholder)';
